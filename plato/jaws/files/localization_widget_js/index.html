<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - localization_widget.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>localization_widget.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">62.64</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">1028</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">76.12</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">10.39</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">/*globals window, PBS, JAWS, document, escape, Ajax, GA_obj, GTMDataLayer, setTimeout, console, location, hide_forced_localization, unescape*/
if (!window.JAWS) {
    window.JAWS = {};
}
// fix for ie
if (!window.console) {
    window.console = {
        log : function () {
            &#039;use strict&#039;;
        },
        warn : function () {
            &#039;use strict&#039;;
        },
        error : function () {
            &#039;use strict&#039;;
        }
    };
}

(function() {
    //IE &gt;= 9 CustomEvent polyfill https://developer.mozilla.org/en-US/docs/Web/API/CustomEvent/CustomEvent
    if (typeof window.CustomEvent === &quot;function&quot;) return false;

    function CustomEvent(event, params) {
        params = params || { bubbles: false, cancelable: false, detail: undefined };
        var evt = document.createEvent(&#039;CustomEvent&#039;);
        evt.initCustomEvent(event, params.bubbles, params.cancelable, params.detail);
        return evt;
    }

    CustomEvent.prototype = window.Event.prototype;

    window.CustomEvent = CustomEvent;
})();


JAWS.Localization = (function () {
    &#039;use strict&#039;;
    var staExtended,
        redirect_to,
        // serverUrl = &#039;http://localhost:8080/&#039;,
        serverUrl = &#039;@SITE_URL@&#039;,
        donate_url = &#039;http://www.pbs.org/donate/&#039;,
        kidsCookie,
        stationCookie,
        preventOverlaysCookie,
        trackingCategory = &quot;Auto-localization overlay&quot;,
        filesLoaded = false,
        setOnce = false,
        initialCallSign = false,
        localizationType,
        modalOverlay,
        confirmOverlay,
        modalFind,
        modalConfirm,
        needsRefresh = false,
        post_data = {},
        modalList,
        bodyElem = document.querySelector(&#039;body&#039;),
        localizationUrl = serverUrl + &#039;localization/&#039;,
        localizationZip = localizationUrl + &#039;member/zip-code/&#039;,
        zipCode,
        donate,
        localizationData = {},
        autoSelectedStation = {},
        // localizationCss = [serverUrl + &#039;static/css/localization.css&#039;],
        localizationCss = [&#039;@LOCALIZATION_CSS_URL@&#039; + &#039;css/localization.css&#039;],
        ajax;
    /***************************/
    /* START Helping functions */
    /***************************/
    if(typeof trackEvent == &#039;undefined&#039;){
        // tracking functions, note fourth parameter for setting the non-interaction flag
        window.trackEvent = function(target, action, label, nonInteraction) {
            if (typeof GTMDataLayer !== &quot;undefined&quot;) {
                var nonInteraction = nonInteraction ? nonInteraction : false;
                GTMDataLayer.push({
                    &#039;event&#039; : &#039;GlobalChrome&#039;,
                    &#039;category&#039; : target,
                    &#039;action&#039; : action,
                    &#039;label&#039; : label,
                    &#039;nonInteraction&#039; : nonInteraction,
                });
            }
        }
    }


    // cookie related functions
    function getDomainName(hostName) {
        return hostName.substring(hostName.lastIndexOf(&quot;.&quot;, hostName.lastIndexOf(&quot;.&quot;) - 1));
    }

    function createCookie(name, value, days) {
        var expires = &quot;&quot;,
            domain = &quot;.pbs.org&quot;,
            date;

        if (days) {
            date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = &quot;; expires=&quot; + date.toGMTString();
        }
        if (window.location.hostname !== &quot;&quot;) {
            domain = getDomainName(window.location.hostname);
        }

        document.cookie = name + &quot;=&quot; + value + expires + &quot;; path=/; domain=&quot; + domain;
    }

    function readCookie(name) {
        var nameEQ = name + &quot;=&quot;,
            ca = document.cookie.split(&#039;;&#039;),
            i,
            c;

        for (i = 0; i &lt; ca.length; i += 1) {
            c = ca[i];
            while (c.charAt(0) === &#039; &#039;) {
                c = c.substring(1, c.length);
            }
            if (c.indexOf(nameEQ) === 0) {
                return c.substring(nameEQ.length, c.length);
            }
        }
        return null;
    }

    function eraseCookie(name) {
        createCookie(name, &quot;&quot;, -1);
    }

    function isInteger(number) {
        var regex = /^-?\d+$/;
        return regex.test(number);
    }
    /*************************/
    /* END Helping functions */
    /*************************/
    // cookie monster
    function cookieMonster(station) {
        var pbsKidsImage = document.createElement(&#039;iframe&#039;);
        pbsKidsImage.src = &#039;http://pbskids.org/localization/p.gif?pbs.station=&#039; + station;
        pbsKidsImage.style.display = &#039;none&#039;;
        document.body.appendChild(pbsKidsImage);
    }

    // localize user
    function localizeUser(stationData) {
        createCookie(&#039;pbsol.common.name&#039;, stationData.common_name, 356);
        createCookie(&#039;pbsol.station&#039;, stationData.station, 356);

    }

    function setDonateLink(donateLink){
        var donateBtn = document.querySelector(&quot;.donate-btn&quot;);
        if(donateBtn &amp;&amp; donateLink){
            donateBtn.href = donateLink;
        }
    }

    //set station logo for header
    function setStationLogo(name, url, img_url) {
        var stationName = document.querySelector(&#039;#pbs_loc_st #pbs_loc_name&#039;),
            img;

        if(stationName){
            img = stationName.querySelector(&#039;img&#039;);
        }

        if (!img) {
            img = document.createElement(&#039;img&#039;);
        }
        img.src = img_url + &#039;.resize.160x78.png&#039;;
        img.alt = name;

        if (stationName) {
            stationName.querySelector(&#039;span&#039;).innerHTML = name;
            stationName.appendChild(img);
            stationName.title = name;
            stationName.href = url;
            stationName.className = &quot;localize&quot;;
        }
    }

    // change station logo
    function changeStationLogo(logo, shortCommonName) {
        var logoHolder = document.querySelector(&#039;.modalStationImage&#039;);
        logoHolder.innerHTML = &#039;&lt;img src=&quot;http://image.pbs.org/station-images/StationColorProfiles/color/&#039; + logo + &#039;.png.resize.106x106.png&quot; alt=&quot;&#039;+ shortCommonName +&#039;&quot;&gt;&#039;;
    }

    function closest(el, fn) {
        return el &amp;&amp; (
            fn(el) ? el : closest(el.parentNode, fn)
        );
    }
    // select station
    function selectStation(evt) {
        var stationItems = document.querySelectorAll(&#039;#autoStationsList .stationItem&#039;),
            that = evt.target,
            stationId,
            stationElem,
            stationCommonName;

        Array.prototype.forEach.call(stationItems, function (el) {
            el.jwRemoveClass(&#039;active&#039;);
            el.setAttribute(&#039;aria-pressed&#039;, &#039;false&#039;);
        });
        // hightlight the current station item
        stationElem = closest(that, function(el){return el.tagName.toLowerCase() === &#039;button&#039;;});
        stationId = stationElem.id;
        stationElem.jwAddClass(&#039;active&#039;);
        stationElem.setAttribute(&#039;aria-pressed&#039;, &#039;true&#039;);
        stationCommonName = stationElem.getAttribute(&#039;data-common_name&#039;);
        changeStationLogo(stationId, stationCommonName);
    }

    // toggles station elements
    function toggleElements(state) {
        var noStations = document.querySelectorAll(&#039;.localizationStationListNoStations&#039;),
            hasStations = document.querySelectorAll(&#039;.localizationStationList&#039;);
        if (!state) {
            Array.prototype.forEach.call(noStations, function (el) {
                el.jwRemoveClass(&#039;none&#039;);
            });
            Array.prototype.forEach.call(hasStations, function (el) {
                el.jwAddClass(&#039;none&#039;);
            });
        } else if (state) {
            Array.prototype.forEach.call(noStations, function (el) {
                el.jwAddClass(&#039;none&#039;);
            });
            Array.prototype.forEach.call(hasStations, function (el) {
                el.jwRemoveClass(&#039;none&#039;);
            });
        }
    }

    // Add stations
    function addStations(data) {
        var defaultStation = data[0],
            stationHTML = &#039;&#039;,
            stationsLength = Object.keys(data).length,
            modalList = document.querySelector(&#039;#pbs-stations-list&#039;),
            stationsSection = document.querySelector(&#039;#autoSelectStation&#039;),
            stations = document.querySelector(&#039;#autoStationsList&#039;),
            stationItems,
            index;

        toggleElements(true);
        modalList.jwRemoveClass(&#039;oneStation&#039;);
        modalList.jwRemoveClass(&#039;twoStation&#039;);

        switch (stationsLength) {
            case 0:
                toggleElements(false);
                trackEvent(trackingCategory, &#039;No Stations for Zip&#039;, &#039;viewed step&#039;);
                break;
            case 1:
                modalList.jwAddClass(&#039;oneStation&#039;);
                break;
            case 2:
                modalList.jwAddClass(&#039;twoStation&#039;);
                break;
        }

        if (defaultStation &amp;&amp; defaultStation.flagship) {
            changeStationLogo(defaultStation.flagship, defaultStation.common_name_short);
            if (!setOnce &amp;&amp; localizationType === &#039;forced&#039;) {
                localizeUser({
                    &#039;common_name&#039;: defaultStation.common_name_short,
                    &#039;station&#039;: defaultStation.flagship,
                    &#039;zipCode&#039;: defaultStation.zip_code
                });
                setOnce = true;
            }
        }

        for (index = 0; index &lt; data.length; index += 1) {

            stationHTML += &#039;&lt;button id=&quot;&#039; + data[index].flagship + &#039;&quot; class=&quot;stationItem&#039; + (index === 0 ? &#039; active&#039; : &#039;&#039;) + &#039;&quot; data-donate_url=&quot;&#039; + data[index].membership_url + &#039;&quot; data-common_name=&quot;&#039; + data[index].common_name_short + &#039;&quot; data-zipcode=&quot;&#039; + data[index].zip_code + &#039;&quot; aria-pressed=&quot;&#039;+ (index === 0 ? &#039;true&#039; : &#039;false&#039;) +&#039;&quot;&gt;&#039;;
            stationHTML += &#039;&lt;h3&gt;&lt;strong class=&quot;commonName&quot;&gt;&#039; + data[index].common_name + &#039;&lt;/strong&gt;&lt;strong class=&quot;shortCommonName&quot;&gt;&#039; + data[index].common_name_short + &#039;&lt;/strong&gt;&lt;/h3&gt;&#039;;
            stationHTML += &#039;&lt;span&gt;&#039; + data[index].address + &#039;&lt;/span&gt;&#039;;
            stationHTML += &#039;&lt;/button&gt;&#039;;
        }
        stations.innerHTML = stationHTML;
        stationsSection.jwRemoveClass(&#039;none&#039;);
        stationItems = stations.querySelectorAll(&#039;.stationItem&#039;);

        // add event listeners for station items
        Array.prototype.forEach.call(stationItems, function (el) {
            el.addEventListener(&#039;click&#039;, selectStation);
        });
    }

    // CSS SCRIPTS CALL FUNCTION
    function loadStylesheets(urls, callback) {
        var link;
        Array.prototype.forEach.call(urls, function (key) {
            var cacheBuster = &#039;?&#039; + (new Date()).getTime();
            link = document.createElement(&quot;link&quot;);
            link.rel = &quot;stylesheet&quot;;
            link.type = &quot;text/css&quot;;
            link.href = key + cacheBuster;
            if(callback){
                link.addEventListener(&#039;load&#039;, callback);
            }
            document.head.appendChild(link);
        });

        filesLoaded = true;
    }

    // INSERT CONTENT
    function insertContent(html) {
        var container;

        if (typeof html === &quot;undefined&quot;) {
            throw &quot;No html has specified&quot;;
        }

        container = document.querySelector(&quot;#jaws_localization&quot;);
        if (!container) {
            container = document.createElement(&quot;div&quot;);
            container.className = &quot;pbs-cleanslate&quot;;
            container.id = &quot;jaws_localization&quot;;
        }

        container.innerHTML = html;

        document.body.insertBefore(container, document.body.firstChild);
    }

    // passing focus once the modals are closed
    function passFocusOnClose(){
        var passFocusToOnClose = bodyElem.getAttribute(&#039;data-pass-focus-to-on-close&#039;);
        // will return an element or undefined, based on bodyElem.getAttribute(&#039;data-pass-focus-to-on-close&#039;)
        var targetElem = document.getElementById(passFocusToOnClose);
        // will return true if targetElem exists AND is actually visible (using offsetHeight)
        var targetIsVisible = targetElem &amp;&amp; targetElem.offsetHeight !== 0;

        if (!targetIsVisible){
            // if the target either doesn&#039;t exist, or isn&#039;t visible, target the body
            targetElem = bodyElem;
        }

        // actually pass focus
        targetElem.focus();
        bodyElem.removeAttribute(&#039;data-pass-focus-to-on-close&#039;);
    }

    // switch between modals
    function switchModals(state) {
        var localization_widget,
            activeStationListItem = document.querySelector(&#039;#autoStationsList .stationItem.active&#039;);
        // modals
        modalFind = document.querySelector(&#039;#pbs-find-stations&#039;);
        modalList = document.querySelector(&#039;#pbs-stations-list&#039;);
        modalConfirm = document.querySelector(&#039;#pbs-confirm-station&#039;);

        switch (state) {
            case &#039;list&#039;:
                modalFind.jwAddClass(&#039;none&#039;);
                modalConfirm.jwAddClass(&#039;none&#039;);
                modalList.jwRemoveClass(&#039;none&#039;);
                modalOverlay.jwRemoveClass(&#039;none&#039;);
                confirmOverlay.jwAddClass(&#039;none&#039;);
                trackEvent(trackingCategory, &#039;Confirm Station&#039;, &#039;Viewed Overlay&#039;);
                modalList.focus();
                window.addEventListener(&#039;keyup&#039;, closeOnEscape);
                modalList.addEventListener(&#039;keydown&#039;, onKeyDown);
                break;
            case &#039;find&#039;:
                modalList.jwAddClass(&#039;none&#039;);
                modalConfirm.jwAddClass(&#039;none&#039;);
                modalFind.jwRemoveClass(&#039;none&#039;);
                modalOverlay.jwRemoveClass(&#039;none&#039;);
                confirmOverlay.jwAddClass(&#039;none&#039;);
                if(activeStationListItem){
                    activeStationListItem.jwRemoveClass(&#039;active&#039;);
                }
                trackEvent(trackingCategory, &#039;Find Station&#039;, &#039;viewed step&#039;);
                modalFind.focus();
                modalList.removeEventListener(&#039;keydown&#039;, onKeyDown);
                window.addEventListener(&#039;keyup&#039;, closeOnEscape);
                modalFind.addEventListener(&#039;keydown&#039;, function(evt){
                    // we just need the keydown event listener on the modal itself, not it&#039;s children
                    if (evt.target === modalFind){
                        onKeyDown(evt);
                    }
                });
                break;
            case &#039;confirm&#039;:
                modalOverlay.jwAddClass(&#039;none&#039;);
                confirmOverlay.jwRemoveClass(&#039;none&#039;);
                modalConfirm.jwRemoveClass(&#039;none&#039;);
                positionConfirmModal();
                bodyElem.style.overflow = &#039;auto&#039;;
                break;
            default:
                if (modalList) {
                    modalList.jwAddClass(&#039;none&#039;);
                }
                if (modalFind) {
                    modalFind.jwAddClass(&#039;none&#039;);
                }
                if (modalConfirm) {
                    modalConfirm.jwAddClass(&#039;none&#039;);
                }
                localization_widget = document.querySelector(&#039;#jaws_localization&#039;);
                if (localization_widget) {
                    localization_widget.parentNode.removeChild(localization_widget);
                }
                bodyElem.style.overflow = &#039;auto&#039;;
                passFocusOnClose();
                window.removeEventListener(&#039;keyup&#039;, closeOnEscape);
        }
    }

    function createEvent(name, evData, bubbles, cancelable){
        var ev;

        if(window.CustomEvent){
            ev = new CustomEvent(name, {
                detail: evData || {},
                data: evData || {},
                bubbles: bubbles || true,
                cancelable: cancelable || true
            });
        }else{
            if (document.createEvent) {
                ev = document.createEvent(&quot;HTMLEvents&quot;);
                ev.initEvent(name, bubbles || true, cancelable || true);
            } else {
                ev = document.createEventObject();
                ev.eventType = name;
            }
            ev.eventName = name;
            ev.data = evData || {};
        }

        return ev;
    }

    function fireEvent(evt){
        if (document.createEvent) {
            document.dispatchEvent(evt);
        } else {
            document.fireEvent(&quot;on&quot; + evt.eventType, evt);
        }
    }

    /**
     * Handles keyDown events - see &#039;keydown&#039; event listeners that invoke this.
     * @param {event} evt - the keyboard event
     * @attr {string} data-pass-focus-on-tab-to - the id we want to
     * pass focus to on regular tab
     * @attr {string} data-pass-focus-on-shift-tab-to - the id we want to
     * pass focus to on *shift* tab
     */
    function onKeyDown(evt){
        var el = evt.target;
        var tabKeyCode = 9;
        var returnKeyCode = 13;
        var spaceKeyCode = 32;
        var tabFocusTarget = el.getAttribute(&#039;data-pass-focus-on-tab-to&#039;);
        var shiftTabFocusTarget = el.getAttribute(&#039;data-pass-focus-on-shift-tab-to&#039;);

        // Is this a return or space key press? If so, invoke close();
        if (evt.keyCode === returnKeyCode || evt.keyCode === spaceKeyCode) {
            prepareToClose(evt);
            return;
        }

        // Here is where we trap focus
        // Is this a tab key event?
        if (evt.keyCode === tabKeyCode){
            // if there is a shift key, and shiftTabFocusTarget
            if ( evt.shiftKey &amp;&amp; shiftTabFocusTarget ) {
                evt.preventDefault();
                document.getElementById(shiftTabFocusTarget).focus();
            } else if ( !evt.shiftKey &amp;&amp; tabFocusTarget) {
                // else if it&#039;s not with the shift key, and there is a
                // tabFocusTarget
                evt.preventDefault();
                document.getElementById(tabFocusTarget).focus();
            }
        }
    }

    /**
     * When the escape key is hit, invoke close() or switchModals()
     * @param {event} evt - the keyboard event
     */
    function closeOnEscape(evt){
        var escKeyCode = 27;
        var selectedStation = document.querySelector(&#039;#autoStationsList .stationItem.active&#039;);
        var modalFind = document.querySelector(&#039;#pbs-find-stations&#039;);
        var modalList = document.querySelector(&#039;#pbs-stations-list&#039;);
        var confirmOverlay = document.querySelector(&#039;#pbs-confirm-station&#039;);

        if (evt.keyCode === escKeyCode){
            if (needsRefresh) {
                prepareToClose(evt, true);
            } else {
                switchModals();
            }
        }
    }

    /**
     * Gets ready to close the various modals - as the closing is actually done by switchModals();
     * @param {event} evt - the event that triggered close()
     * @param {boolean} initLocalize - if we want to init localization programatically
     * This function is long, and complicated, and in desperate need of a refactor
     */
    function prepareToClose(evt, initLocalize) {
        var that = evt.target,
            selectedStation = document.querySelector(&#039;#autoStationsList .stationItem.active&#039;),
            station,
            stationList = Array.prototype.slice.call(document.getElementById(&#039;autoStationsList&#039;).children);

        function callback(){
            if (redirect_to) {
                window.location.href = redirect_to;
            } else {
                if (!that.getAttribute(&#039;data-noreload&#039;)) {
                    location.reload();
                } else {
                    switchModals();
                }
            }
        }

        function handleButtonAction(stationData){
            if (that.getAttribute(&#039;class&#039;) === &#039;closeBtn&#039;) {
                // autolocalization
                if (localizationType === &#039;forced&#039;) {
                    if(selectedStation){
                        trackEvent(trackingCategory, &#039;Close&#039;, selectedStation.getAttribute(&#039;id&#039;) + &#039; - &#039; + parseInt(stationList.indexOf(selectedStation) + 1));
                    }
                    else{
                        if(document.querySelector(&#039;#autoStationsList .stationItem&#039;))
                            trackEvent(trackingCategory, &#039;Find Station&#039;, &#039;Close&#039;);
                        else
                            trackEvent(trackingCategory, &#039;No Stations for Zip&#039;, &#039;Close&#039;);
                        evt.preventDefault();
                        callback();
                        return false;
                    }
                    // reload
                    evt.preventDefault();
                    callback();
                }
                if (localizationType === &#039;manual&#039;) {
                    if(selectedStation){
                        trackEvent(trackingCategory, &#039;Close&#039;, selectedStation.id + &#039; - &#039; + (stationList.indexOf(selectedStation) + 1) );
                    }
                    else{
                        if(document.querySelector(&#039;#autoStationsList .stationItem&#039;) || document.querySelector(&#039;.localizationStationListNoStations&#039;).offsetHeight == 0)
                            trackEvent(trackingCategory, &#039;Find Station&#039;, &#039;Close&#039;);
                        else
                            trackEvent(trackingCategory, &#039;No Stations for Zip&#039;, &#039;Close&#039;);
                            //trackEvent(trackingCategory, &#039;Find Station&#039;, &#039;Close&#039;);
                    }
                    switchModals();
                }
                if(redirect_to){
                    window.location.href = redirect_to;
                }
            }

            if (that.id === &#039;confirmStation&#039; ||
                that.getAttribute(&#039;data-confirm-station&#039;) === &#039;true&#039; ||
                initLocalize) {
                // the following code will assure that the page doesn&#039;t go in infinite loop
                // there&#039;s another piece of code somewhere that fires the click event
                // lvl 100 wizard magic, event.detail means how many times the button has been pressed,
                // 0 means it has been triggered by code
                // we need to make sure this isn&#039;t a keyboard press, so we make sure keyCode is undefined
                if (typeof evt.keyCode === &#039;undefined&#039; &amp;&amp; evt.detail == 0) {
                //here be dragons - lvl 101 dark elven magic - hack for IE 11, touch event
                    if(evt.pointerId != 1)
                        return;
                }

                // If the &#039;data-ga-event&#039; attribute isn&#039;t present, track events one way
                if(!that.getAttribute(&#039;data-ga-event&#039;)){
                    trackEvent(trackingCategory, &#039;Confirm&#039;, selectedStation.id + &#039; - &#039; + parseInt(stationList.indexOf(selectedStation) + 1));
                } else {
                    // otherwise use the attribute in the event
                    // This attribute is currently only in the overlay
                    trackEvent(trackingCategory, &#039;Is This Your Station&#039;, that.getAttribute(&#039;data-ga-event&#039;) + &#039; - &#039; + initialCallSign);
                }

                localizeUser(station);

                // The custom event that will be created
                var confirmEvent = createEvent(&#039;confirmStationEvent&#039;, {
                                        link: stationData.donate_url,
                                        zipCode: stationData.zip_code,
                                        confirmBtn: that.getAttribute(&#039;id&#039;) ? &quot;#&quot; + that.getAttribute(&#039;id&#039;) : &#039;&#039;,
                                        donate: donate,
                                        station: stationData.call_sign
                                    });

                fireEvent(confirmEvent);

                var donate_location = &quot;@PBS_DONATE_URL@&quot;;

                // reload
                evt.preventDefault();
                callback();
            }
        }

        // Here is where the action starts: first, is there a selectedStation?
        if (selectedStation) {
            // get station details for selected station
            var ajax = new Ajax({
                url : localizationUrl + &#039;false/?callsign=&#039; + selectedStation.getAttribute(&#039;id&#039;),
                type : &#039;JSONP&#039;
            }, function (data) {
                var stationData = data.station.skylab_data;
                station = {
                    &#039;common_name&#039;: stationData.short_common_name,
                    &#039;station&#039;: stationData.call_sign,
                    &#039;zipCode&#039;: stationData.zip_code,
                    &#039;donate_url&#039;: stationData.donate_url,
                    &#039;tvss_url&#039;: stationData.tvss_url
                };
                handleButtonAction(stationData);
            });
        } else if (needsRefresh) {
            // if there is no selectedStation, but needsRefresh is true [see autolocalize()], invoke callback()
            callback();
        } else {
            // if there is no selectedStation, and needsRefresh is false
            // (which is the case if modals have been opened in a localized state)
            // we invoke switchModals() - which, in the default state, closes and removes all modals
            switchModals();
        }
    }

    // localize by state
    function localizeState() {
        var state = document.querySelector(&#039;#regionSelect&#039;).value,
            stateError = document.querySelector(&#039;#regionSelect&#039;).parentElement.querySelector(&#039;.errorMsg&#039;),
            ajax;
        stateError.jwAddClass(&quot;none&quot;);

        if (state !== &#039;&#039;) {
            trackEvent(trackingCategory, &#039;Find Station&#039;, &quot;Search by state - &quot; + state);
            ajax = new Ajax({
                url : localizationUrl + &#039;member/state/&#039; + state + &#039;/&#039;,
                type : &#039;JSONP&#039; // GET, POST, JSON, JSONP
            }, function (data) {
                addStations(data.stations_list);
                switchModals(&#039;list&#039;);
            });
        } else {
            stateError.jwRemoveClass(&quot;none&quot;);
            return false;
        }
    }

    // localize by zip
    function localizeZip() {
        var zipValue = document.querySelector(&#039;#zipInput&#039;).value,
            zipError = document.querySelector(&#039;#zipInput&#039;).parentElement.querySelector(&#039;.errorMsg&#039;),
            zipCode = document.querySelector(&#039;#zipInput&#039;),
            isValidZip = /(^\d{5}$)/.test(zipValue),
            ajax;

        zipError.jwAddClass(&quot;none&quot;);

        if (zipValue === &quot;&quot;) {
            zipError.innerHTML = &quot;Please enter a valid zip code&quot;;
            zipError.jwRemoveClass(&quot;none&quot;);
            return false;
        }

        if (!isValidZip) {
            if (!isInteger(zipValue)) {
                zipError.innerHTML = &#039;Zipcode is not numeric&#039;;
                zipError.jwRemoveClass(&quot;none&quot;);
                return false;
            }

            if (zipValue.toString().length &lt;= 4) {
                zipError.innerHTML = &#039;Zipcode too short&#039;;
                zipError.jwRemoveClass(&quot;none&quot;);
                return false;
            }
        } else {
            trackEvent(trackingCategory, &#039;Find Station&#039;, &quot;Search by zip - &quot; + zipValue);
            ajax = new Ajax({
                url : localizationUrl + &#039;member/zip-code/&#039; + zipValue + &#039;/&#039;,
                type : &#039;JSONP&#039; // GET, POST, JSON, JSONP
            }, function (data) {
                addStations(data.stations_list);
                switchModals(&#039;list&#039;);
                zipCode = zipValue;
            });
        }
    }

    function positionConfirmModal(){
        var confirmBox = document.querySelector(&#039;#pbs-confirm-station&#039;);
        if(!confirmBox){
            return;
        }
        var arrowBox = confirmBox.querySelectorAll(&#039;.arrow-box&#039;)[0],
            before = confirmBox.querySelectorAll(&#039;.before&#039;)[0],
            after = confirmBox.querySelectorAll(&#039;.after&#039;)[0],
            // producer&#039;s header widget and pbs.org has the first element
            // national video portal has this the second element
            // look for both
            callsign = (document.querySelector(&#039;#pbs_loc_name&#039;) ||
                        document.querySelector(&#039;#localizedStation&#039;)),
            callsignWidth = callsign.offsetWidth;

        callsign.parentElement.insertBefore(confirmBox, callsign);

        function positionBox(){
            var mobileBreakpoint = window.matchMedia(&#039;(max-width: 960px)&#039;),
                callsignLeft = callsign.offsetLeft;

            after.jwRemoveClass(&#039;top-right&#039;);
            before.jwRemoveClass(&#039;top-right&#039;);
            after.jwRemoveClass(&#039;top-left&#039;);
            before.jwRemoveClass(&#039;top-left&#039;);

            if(callsignLeft + callsignWidth &lt; document.body.offsetWidth / 2){
                after.jwAddClass(&#039;top-left&#039;);
                before.jwAddClass(&#039;top-left&#039;);
                confirmBox.style.textAlign = &#039;left&#039;;
                arrowBox.style.marginLeft  = callsignLeft - before.offsetLeft / 2 + &#039;px&#039;;
                arrowBox.style.marginRight  = callsignLeft - before.offsetLeft / 2 + &#039;px&#039;;
            }else{
                after.jwAddClass(&#039;top-right&#039;);
                before.jwAddClass(&#039;top-right&#039;);
                confirmBox.style.textAlign = &#039;right&#039;;
                arrowBox.style.marginLeft  = 0 + &#039;px&#039;;
                arrowBox.style.marginRight  = 0 + &#039;px&#039;;
            }
        }

        window.addEventListener(&#039;resize&#039;, positionBox);
        positionBox();
    }

    // Create the stations overlay
    function createOverlay(state) {
        var closeBtn,
            confirmBtn,
            moreStations,
            searchByZip,
            searchByState,
            initialShortCommonName,
            confirmCallsign,
            confirmButton,
            changeStations,
            backBtn;
        // insert the stations overlay
        if (localizationData.localization_overlay !== &#039;&#039;) {
            insertContent(localizationData.localization_overlay);

            // the first station logo
            if (localizationData.stations_list.length &gt; 0) {
                // add stations to the overlay
                addStations(localizationData.stations_list);
                confirmCallsign = document.querySelectorAll(&#039;.confirmCallsign&#039;);

                // autolocalize to first station, let the user confirm it
                initialShortCommonName = localizationData.stations_list[0].common_name_short;

                // see the top level variable
                initialCallSign = localizationData.stations_list[0].callsign;

                for (var i = 0; i &lt; confirmCallsign.length; i++) {
                    confirmCallsign[i].innerHTML = initialShortCommonName;
                }
            }

            // close the modal
            closeBtn = document.querySelectorAll(&#039;.closeBtn, .close&#039;);
            changeStations = document.querySelectorAll(&#039;.changeStation&#039;);
            moreStations = document.querySelectorAll(&#039;.showStatesModal&#039;);
            confirmBtn = document.querySelectorAll(&#039;.modalConfirmStation&#039;);
            modalOverlay = document.querySelector(&#039;#pbs-modal-overlay&#039;);
            confirmOverlay = document.querySelector(&#039;#pbs-confirm-modal-overlay&#039;);
            searchByZip = document.querySelector(&#039;#searchByZip&#039;);
            searchByState = document.querySelector(&#039;#serchByRegion&#039;);
            backBtn = document.querySelector(&#039;#backButton&#039;);

            // close buttons event listener
            Array.prototype.forEach.call(closeBtn, function (el) {
                el.addEventListener(&#039;click&#039;, prepareToClose);
                // this keydown event listener works keyboard users
                el.addEventListener(&#039;keydown&#039;, onKeyDown);
            });

            // confirm button event listener
            Array.prototype.forEach.call(confirmBtn, function(el){
                el.addEventListener(&#039;click&#039;, prepareToClose);
                // this keydown event listener works keyboard users
                el.addEventListener(&#039;keydown&#039;, onKeyDown);
            });

            // more stations button event listener
            Array.prototype.forEach.call(changeStations, function(el){
                el.addEventListener(&#039;click&#039;, function (evt) {
                    var errors = document.querySelectorAll(&quot;.errorMsg&quot;),
                        i,
                        stationListItem = document.querySelector(&#039;#autoStationsList .active&#039;);
                    for (i = 0; i &lt; errors.length; i += 1) {
                        errors[i].jwAddClass(&quot;none&quot;);
                    }
                    trackEvent(trackingCategory, &#039;Is This Your Station&#039;, &#039;Change - &#039; + initialCallSign);
                    switchModals(&#039;list&#039;);
                    evt.preventDefault();
                });
            });

            Array.prototype.forEach.call(moreStations, function(el){
                el.addEventListener(&#039;click&#039;, function (evt) {
                    trackEvent(trackingCategory, &#039;More Stations&#039;, &#039;&#039;);
                    createOverlay(&#039;find&#039;);
                });
            });

            // zip code
            searchByZip.addEventListener(&#039;click&#039;, localizeZip);
            // state
            searchByState.addEventListener(&#039;click&#039;, localizeState);
            // back button
            backBtn.addEventListener(&#039;click&#039;, function (evt) {
                switchModals(&#039;find&#039;);
                evt.preventDefault();
            });
            bodyElem.style.overflow = &#039;hidden&#039;;
            // select correct modal
            switchModals(state);
        }
    }

    // autolocalization
    function autolocalize() {
        var url = localizationUrl + &#039;true/&#039;,
            ajax;
        if (stationCookie) {
            url += &quot;?callsign=&quot; + stationCookie;
        } else {
            if (post_data &amp;&amp; post_data.extended) {
                url += &#039;?extended=&#039; + JSON.stringify(post_data);
            }
        }

        // autolocalization started, prevent other scripts from triggering it
        window.skipAutoLocalization = true;

        ajax = new Ajax({
            url : url,
            type : &#039;JSONP&#039; // GET, POST, JSON, JSONP
        }, function (data) {
            localizationType = &#039;forced&#039;;
            localizationData = data;
            var callsign = localizationData.stations_list[0].flagship;

            // prevents other overlays such as lightboxes this sesion
            createCookie(&quot;pbs.preventOverlays&quot;, 1, 0);
            ajax = new Ajax({
                url : localizationUrl + &quot;false/?callsign=&quot; + callsign,
                type : &#039;JSONP&#039; // GET, POST, JSON, JSONP
            }, function (data) {
                autoSelectedStation = data.station;
                zipCode = autoSelectedStation.zip_code;
                var localizedEv = createEvent(&#039;jaws.localized&#039;,
                                              { station: autoSelectedStation});

                setStationLogo(autoSelectedStation.short_name,
                               autoSelectedStation.site_address,
                               autoSelectedStation.logo_url);
                setDonateLink(autoSelectedStation.membership_url);
                needsRefresh = true;
                createOverlay(&#039;confirm&#039;);
                fireEvent(localizedEv);

                // passing focus to the overlay once it&#039;s been invoked
                var confirmBox = document.querySelector(&#039;#pbs-confirm-station-box&#039;);
                confirmBox.focus();
                trackEvent(trackingCategory, &#039;Is This Your Station&#039;, &#039;Viewed Overlay&#039;, true);

                confirmBox.addEventListener(&#039;keydown&#039;, function(evt){
                    // we just need the keydown event listener on the modal itself, not it&#039;s children
                    if (evt.target === confirmBox){
                        onKeyDown(evt);
                    }
                });
                // now that the overlay is present, let&#039;s listen for keyup
                window.addEventListener(&#039;keyup&#039;, closeOnEscape);
            });
        });
    }

    // manual localization
    function init(popup_location, redirect_url) {
        redirect_to = redirect_url || null;
        popup_location = popup_location || &#039;&#039;; // optional parameter
        donate = popup_location;
        trackingCategory = &quot;See more Stations â€“ Localization Overlay&quot;;

        var url = localizationUrl + &#039;true/&#039;,
            ajax;

        initCookieData();

        if (stationCookie) {
            if (post_data &amp;&amp; post_data.extended) {
                url += &#039;?extended=&#039; + JSON.stringify(post_data);
            } else {
                url += &quot;?callsign=&quot; + stationCookie;
            }
            if (popup_location == &#039;Donate&#039; || popup_location == &#039;TVSchedules&#039;) {
                url += &#039;&amp;popup_location=&#039; + popup_location;
            }
        }
        else {
            if (popup_location == &#039;Donate&#039; || popup_location == &#039;TVSchedules&#039;) {
                url += &#039;?popup_location=&#039; + popup_location;
            }
        }

        ajax = new Ajax({
            url : url,
            type : &#039;JSONP&#039; // GET, POST, JSON, JSONP
        }, function (data) {
            localizationData = data;
            localizationType = &#039;manual&#039;;
            zipCode = data.zip || zipCode;
            if (staExtended &amp;&amp; !popup_location) {
	            createOverlay(&#039;list&#039;);
            } else {
                createOverlay(&#039;find&#039;);
            }
        });
    }

    function processStaExtendedCookie(key) {
        var cookieData = staExtended,
            cookieArray = decodeURIComponent(cookieData).split(&#039;#&#039;),
            regex = new RegExp(&quot;^&quot; + key + &quot;=&quot;, &quot;g&quot;),
            data;

        Array.prototype.forEach.call(cookieArray, function (v) {
            if (regex.test(v)) {
                var temp = v.split(&#039;=&#039;);
                data = temp[1];
                data = data.replace(&#039;[&#039;, &#039;&#039;);
                data = data.replace(&#039;]&#039;, &#039;&#039;);
                data = data.replace(/&quot;/g, &#039;&#039;);
                data = data.split(&#039;,&#039;);
            }
        });
        return data;
    }

    function initCookieData(){
        staExtended = readCookie(&#039;pbsol.sta_extended&#039;);
        kidsCookie = readCookie(&#039;pbskids.localized&#039;);
        stationCookie = readCookie(&#039;pbsol.station&#039;);
        preventOverlaysCookie = readCookie(&#039;pbs.preventOverlays&#039;);

        if (staExtended) {
            post_data.extended = {
                zip: processStaExtendedCookie(&quot;z&quot;)[0],
                state: processStaExtendedCookie(&quot;st&quot;)[0],
                stations: processStaExtendedCookie(&quot;s&quot;)
            };
        }
    }

    initCookieData();

    // load necesarry files
    if (!filesLoaded) {
        loadStylesheets(localizationCss, function(){
            // localize
            // we need the localization.css for this =&gt; wait for it to load
            if (!window.hide_forced_localization) {
                if (!window.skipAutoLocalization) {
                    if (staExtended &amp;&amp; !stationCookie) {
                        autolocalize();
                    }
                }
            }
        });
    }

    if (stationCookie) {
        post_data.callsign = stationCookie;
        ajax = new Ajax({
            url : localizationUrl + &quot;false/?callsign=&quot; + stationCookie,
            type : &#039;JSONP&#039; // GET, POST, JSON, JSONP
        }, function (data) {
            var site_address = data.station.site_address || data.station.stationfinder_url;
            setStationLogo(data.station.short_name, site_address, data.station.logo_url);
            setDonateLink(data.station.membership_url);
        });
    }
    if (stationCookie &amp;&amp; stationCookie !== kidsCookie) {
        cookieMonster(stationCookie);
        createCookie(&#039;pbskids.localized&#039;, stationCookie, 30);
    }

    return {
        init : init
    };
}());
// This needs to be deleted after we will make the changes in PBS ACTIVATE, VideoPortal and PBS projects
var GlobalChrome = {
    &#039;Localization&#039; : {
        &#039;Init&#039; : function () {
            &#039;use strict&#039;;
            JAWS.Localization.init();
        }
    }
};</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
